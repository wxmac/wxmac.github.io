---
title: åå››ã€eventloopäº‹ä»¶å¾ªç¯
date: 2020-1-25
tags:
  - eventloop
  - äº‹ä»¶å¾ªç¯
---

## eventloopäº‹ä»¶å¾ªç¯

 - jsæ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œeventloopäº‹ä»¶å¾ªç¯å°±æ˜¯è§£å†³javaScriptå•çº¿ç¨‹è¿è¡Œé˜»å¡çš„ä¸€ç§æœºåˆ¶ã€‚


## æ¶ˆæ¯é˜Ÿåˆ—

```javascript
const bar = () => console.log('bar')

const baz = () => console.log('baz')

const foo = () => {
  console.log('foo')
  setTimeout(bar, 0)
  baz()
}

foo()

è¯¥ä»£ç ä¼šæ‰“å°ï¼š
foo
baz
bar
```
 1. å½“è°ƒç”¨ setTimeout() æ—¶ï¼Œæµè§ˆå™¨æˆ– Node.js ä¼šå¯åŠ¨å®šæ—¶å™¨ã€‚ å½“å®šæ—¶å™¨åˆ°æœŸæ—¶ï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­ä¼šç«‹å³åˆ°æœŸï¼Œå› ä¸ºå°†è¶…æ—¶å€¼è®¾ä¸º 0ï¼‰ï¼Œåˆ™å›è°ƒå‡½æ•°ä¼šè¢«æ”¾å…¥â€œæ¶ˆæ¯é˜Ÿåˆ—â€ä¸­ã€‚

 2. åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç”¨æˆ·è§¦å‘çš„äº‹ä»¶ï¼ˆå¦‚å•å‡»æˆ–é”®ç›˜äº‹ä»¶ã€æˆ–è·å–å“åº”ï¼‰ä¹Ÿä¼šåœ¨æ­¤æ’é˜Ÿï¼Œç„¶åä»£ç æ‰æœ‰æœºä¼šå¯¹å…¶ä½œå‡ºååº”ã€‚ ç±»ä¼¼ onLoad è¿™æ ·çš„ DOM äº‹ä»¶ä¹Ÿå¦‚æ­¤ã€‚

 3. äº‹ä»¶å¾ªç¯ä¼šèµ‹äºˆè°ƒç”¨å †æ ˆä¼˜å…ˆçº§ï¼Œå®ƒé¦–å…ˆå¤„ç†åœ¨è°ƒç”¨å †æ ˆä¸­æ‰¾åˆ°çš„æ‰€æœ‰ä¸œè¥¿ï¼Œä¸€æ—¦å…¶ä¸­æ²¡æœ‰ä»»ä½•ä¸œè¥¿ï¼Œä¾¿å¼€å§‹å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä¸œè¥¿ã€‚

 
 ## ES6 ä½œä¸šé˜Ÿåˆ—
- ECMAScript 2015 å¼•å…¥äº†ä½œä¸šé˜Ÿåˆ—çš„æ¦‚å¿µï¼ŒPromise ä½¿ç”¨äº†è¯¥é˜Ÿåˆ—ï¼ˆä¹Ÿåœ¨ ES6/ES2015 ä¸­å¼•å…¥ï¼‰ã€‚ è¿™ç§æ–¹å¼ä¼šå°½å¿«åœ°æ‰§è¡Œå¼‚æ­¥å‡½æ•°çš„ç»“æœï¼Œè€Œä¸æ˜¯æ”¾åœ¨è°ƒç”¨å †æ ˆçš„æœ«å°¾ã€‚

- å½“å‰å‡½æ•°ç»“æŸä¹‹å‰ resolve çš„ Promise ä¼šåœ¨å½“å‰å‡½æ•°ä¹‹åè¢«ç«‹å³æ‰§è¡Œã€‚

- æœ‰ä¸ªæ¸¸ä¹å›­ä¸­è¿‡å±±è½¦çš„æ¯”å–»å¾ˆå¥½ï¼šæ¶ˆæ¯é˜Ÿåˆ—å°†ä½ æ’åœ¨é˜Ÿåˆ—çš„åé¢ï¼ˆåœ¨æ‰€æœ‰å…¶ä»–äººçš„åé¢ï¼‰ï¼Œä½ ä¸å¾—ä¸ç­‰å¾…ä½ çš„å›åˆï¼Œè€Œå·¥ä½œé˜Ÿåˆ—åˆ™æ˜¯å¿«é€Ÿé€šé“ç¥¨ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨å®Œæˆä¸Šä¸€æ¬¡ä¹˜è½¦åç«‹å³ä¹˜åå¦ä¸€è¶Ÿè½¦ã€‚

```javascript
const bar = () => console.log('bar')

const baz = () => console.log('baz')

const foo = () => {
  console.log('foo')
  setTimeout(bar, 0)
  new Promise((resolve, reject) =>
    resolve('åº”è¯¥åœ¨ baz ä¹‹åã€bar ä¹‹å‰')
  ).then(resolve => console.log(resolve))
  baz()
}

foo()

è¿™ä¼šæ‰“å°ï¼š
foo
baz
åº”è¯¥åœ¨ baz ä¹‹åã€bar ä¹‹å‰
bar

```
 - è¿™æ˜¯ Promiseï¼ˆä»¥åŠåŸºäº promise æ„å»ºçš„ async/awaitï¼‰ä¸é€šè¿‡ setTimeout() æˆ–å…¶ä»–å¹³å° API çš„æ™®é€šçš„æ—§å¼‚æ­¥å‡½æ•°ä¹‹é—´çš„å·¨å¤§åŒºåˆ«ã€‚
 

### ä¸€ã€å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

- åœ¨ js ä¸­ï¼Œä»»åŠ¡åˆ†ä¸ºå®ä»»åŠ¡(macrotask)å’Œå¾®ä»»åŠ¡(microtask)ï¼Œè¿™ä¸¤ä¸ªä»»åŠ¡åˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå‡é‡‡ç”¨å…ˆè¿›å…ˆå‡º(ç±»ä¼¼æ”¾ç›˜å­)çš„ç­–ç•¥è¿›è¡Œæ‰§è¡Œï¼ŒåŒæ­¥æ‰§è¡Œçš„ä»»åŠ¡éƒ½åœ¨å®ä»»åŠ¡ä¸Šæ‰§è¡Œã€‚



    1. å®ä»»åŠ¡ä¸»è¦æœ‰ï¼šscript(æ•´ä½“ä»£ç )ã€setTimeoutã€setIntervalã€I/Oã€UI äº¤äº’äº‹ä»¶ã€postMessageã€MessageChannelã€setImmediate(Node.js ç¯å¢ƒ)ã€‚
    2. å¾®ä»»åŠ¡ä¸»è¦æœ‰ï¼šPromise.thenã€ MutationObserverã€ process.nextTick(Node.js ç¯å¢ƒ)ã€‚

- å®ä»»åŠ¡æ˜¯ç”±å¤šä¸ªå¾®ä»»åŠ¡ç»„æˆçš„ï¼Œå…ˆæ‰§è¡Œå¾®ä»»åŠ¡ï¼Œåæ‰§è¡Œå®ä»»åŠ¡ã€‚

### äºŒã€è¿è¡Œæœºåˆ¶
- åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¯è¿›è¡Œä¸€æ¬¡å¾ªç¯æ“ä½œç§°ä¸º tickï¼Œæ¯ä¸€æ¬¡ tick çš„ä»»åŠ¡å¤„ç†æ¨¡å‹æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä½†å…³é”®æ­¥éª¤å¦‚ä¸‹ï¼š


    1. æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆæ ˆä¸­æ²¡æœ‰å°±ä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ï¼‰
    2. æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¾®ä»»åŠ¡ï¼Œå°±å°†å®ƒæ·»åŠ åˆ°å¾®ä»»åŠ¡çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­
    3. å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œå½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰
    4. å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ£€æŸ¥æ¸²æŸ“ï¼Œç„¶åGUIçº¿ç¨‹æ¥ç®¡æ¸²æŸ“
    5. æ¸²æŸ“å®Œæ¯•åï¼ŒJSçº¿ç¨‹ç»§ç»­æ¥ç®¡ï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼ˆä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ï¼‰


### ä¸‰ã€ğŸŒ°
 - æŒ‰æ¶ˆæ¯é˜Ÿåˆ— å’Œ  ä½œä¸šé˜Ÿåˆ— æ€è·¯æ›´ç®€å•ã€‚å…ˆæ‰§è¡Œä½œä¸šé˜Ÿåˆ—ï¼Œ åæ‰§è¡Œ ä½œä¸šé˜Ÿåˆ—ã€‚

 ### 1.å°è¯•è¾“å‡ºä»¥ä¸‹ä»£ç  
 ```javascript
    console.log(1);
    setTimeout(function() {
        console.log(2);
    }, 0);
    new Promise(function(resolve) {
        console.log(3);
        resolve(Date.now());
    }).then(function() {
        console.log(4);
    });
    console.log(5);
    setTimeout(function() {
        new Promise(function(resolve) {
            console.log(6);
            resolve(Date.now());
        }).then(function() {
            console.log(7);
        });
    }, 0);
 ```

 - é‚£ä¹ˆä»¥ä¸Šä»£ç çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ


    -  1 3 5 4 2 6 7 
    1. ä»£ç ä»ä¸Šå¾€ä¸‹æ‰§è¡Œï¼Œé¦–å…ˆè¾“å‡º 1ï¼Œ
    2. é‡åˆ°setTimeoutï¼Œæ¨å…¥å®ä»»åŠ¡ï¼Œå¾…åé¢æ‰§è¡Œï¼Œ
    3. é‡åˆ°Promiseï¼Œé¦–å…ˆæ‰“å° 3ï¼ŒæŠŠthenåé¢çš„æ¨å…¥å¾®ä»»åŠ¡ï¼Œ
    4. ç›´æ¥æ‰“å° 5ï¼Œ
    6. é‡åˆ°setTimeoutï¼Œæ¨å…¥å®ä»»åŠ¡ï¼Œå¾…åé¢æ‰§è¡Œï¼Œ
    7. å¾®ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ‰“å° 4ï¼Œ
    8. å®ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ‰“å° 2ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰å¾®ä»»åŠ¡ï¼Œä¸‹ä¸€æ­¥ï¼Œ
    9. æ‰§è¡Œå®ä»»åŠ¡ï¼Œæ‰“å° 6ï¼ŒæŠŠthenåé¢çš„æ¨å…¥å¾®ä»»åŠ¡ï¼Œ
    10. æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œæ‰“å° 7ï¼Œå®Œæˆã€‚


 ### 2.å°è¯•è¾“å‡ºä»¥ä¸‹ä»£ç  

 ```javascript
    async function async1() {
        console.log('async1 start');
        await async2();
        console.log('async1 end');
    }
    async function async2() {
        console.log('async2');
    }
    console.log('script start');
    setTimeout(function() {
        console.log('setTimeout');
    }, 0)
    async1();
    new Promise(function(resolve) {
        console.log('promise1');
        resolve();
    }).then(function() {
        console.log('promise2');
    });
    console.log('script end');

    /**
        await async2()ç­‰ä»·äº
        async2().then(() => {
                console.log('async1 end');
        })
    **/ 
 ```


 ```javascript
    /*
        script start
        async1 start
        async2
        promise1
        script end
        async1 end
        promise2
        setTimeout
    */
 ```
- è§£æ


    1.é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªasyncï¼Œæ²¡è°ƒç”¨ï¼Œç›´æ¥ä¸‹ä¸€æ­¥ï¼Œ
    2.æ‰§è¡Œ script startï¼Œ
    3.é‡åˆ°setTimeoutï¼Œ æ¨å…¥å®ä»»åŠ¡ï¼Œ
    3.æ‰§è¡Œ async1å‡½æ•°,åœ¨awaitä¹‹å‰çš„ä»£ç æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¼šç«‹å³è¾“å‡º async1 start,é‡åˆ°äº†awaitæ—¶ï¼Œä¼šå°†awaitåé¢çš„è¡¨è¾¾å¼æ‰§è¡Œä¸€éï¼Œæ‰€ä»¥å°±ç´§æ¥ç€è¾“å‡ºasync2,æ‰“å°async2ï¼Œ
    4.å¾€ä¸‹èµ°ï¼Œé‡åˆ°Promiseï¼Œæ‰“å°promise1ï¼Œ thenæ¨å…¥å¾®ä»»åŠ¡ï¼Œ
    5.å¾€ä¸‹èµ°ï¼Œæ‰“å°script endï¼Œ
    6.ç»§ç»­æŒ‰é¡ºåºæ‰§è¡Œä¹‹å‰ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡ï¼Œå…ˆæ‰“å°async1 endï¼Œ å†æ‰“å° promise2ï¼Œ
    7.æ‰§è¡Œå®ä»»åŠ¡ï¼Œæ‰“å°setTimeoutã€‚