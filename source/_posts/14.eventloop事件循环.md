---
title: åå››ã€eventloopäº‹ä»¶å¾ªç¯
date: 2020-1-25
tags:
  - eventloop
  - äº‹ä»¶å¾ªç¯
---

## eventloopäº‹ä»¶å¾ªç¯

 - jsæ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œeventloopäº‹ä»¶å¾ªç¯å°±æ˜¯è§£å†³javaScriptå•çº¿ç¨‹è¿è¡Œé˜»å¡çš„ä¸€ç§æœºåˆ¶ã€‚

 
 

### ä¸€ã€å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

 ```javascript
åœ¨ js ä¸­ï¼Œä»»åŠ¡åˆ†ä¸ºå®ä»»åŠ¡(macrotask)å’Œå¾®ä»»åŠ¡(microtask)ï¼Œè¿™ä¸¤ä¸ªä»»åŠ¡åˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå‡é‡‡ç”¨å…ˆè¿›å…ˆå‡º(ç±»ä¼¼æ”¾ç›˜å­)çš„ç­–ç•¥è¿›è¡Œæ‰§è¡Œï¼ŒåŒæ­¥æ‰§è¡Œçš„ä»»åŠ¡éƒ½åœ¨å®ä»»åŠ¡ä¸Šæ‰§è¡Œã€‚
å®ä»»åŠ¡ä¸»è¦æœ‰ï¼šscript(æ•´ä½“ä»£ç )ã€setTimeoutã€setIntervalã€I/Oã€UI äº¤äº’äº‹ä»¶ã€postMessageã€MessageChannelã€setImmediate(Node.js ç¯å¢ƒ)ã€‚
å¾®ä»»åŠ¡ä¸»è¦æœ‰ï¼šPromise.thenã€ MutationObserverã€ process.nextTick(Node.js ç¯å¢ƒ)ã€‚

å®ä»»åŠ¡æ˜¯ç”±å¤šä¸ªå¾®ä»»åŠ¡ç»„æˆçš„ï¼Œå…ˆæ‰§è¡Œå¾®ä»»åŠ¡ï¼Œåæ‰§è¡Œå®ä»»åŠ¡ã€‚
```

### äºŒã€è¿è¡Œæœºåˆ¶
```javascript
    åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¯è¿›è¡Œä¸€æ¬¡å¾ªç¯æ“ä½œç§°ä¸º tickï¼Œæ¯ä¸€æ¬¡ tick çš„ä»»åŠ¡å¤„ç†æ¨¡å‹æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä½†å…³é”®æ­¥éª¤å¦‚ä¸‹ï¼š

    - æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆæ ˆä¸­æ²¡æœ‰å°±ä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ï¼‰
    - æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¾®ä»»åŠ¡ï¼Œå°±å°†å®ƒæ·»åŠ åˆ°å¾®ä»»åŠ¡çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­
    - å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œå½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰
    - å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ£€æŸ¥æ¸²æŸ“ï¼Œç„¶åGUIçº¿ç¨‹æ¥ç®¡æ¸²æŸ“
    - æ¸²æŸ“å®Œæ¯•åï¼ŒJSçº¿ç¨‹ç»§ç»­æ¥ç®¡ï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼ˆä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ï¼‰
```


### ä¸‰ã€ğŸŒ°
 ### 1.å°è¯•è¾“å‡ºä»¥ä¸‹ä»£ç  
 ```javascript
    console.log(1);
    setTimeout(function() {
        console.log(2);
    }, 0);
    new Promise(function(resolve) {
        console.log(3);
        resolve(Date.now());
    }).then(function() {
        console.log(4);
    });
    console.log(5);
    setTimeout(function() {
        new Promise(function(resolve) {
            console.log(6);
            resolve(Date.now());
        }).then(function() {
            console.log(7);
        });
    }, 0);
 ```

 - é‚£ä¹ˆä»¥ä¸Šä»£ç çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ
 ```javascript
    //  1 3 5 4 2 6 7 
    1.ä»£ç ä»ä¸Šå¾€ä¸‹æ‰§è¡Œï¼Œé¦–å…ˆè¾“å‡º 1ï¼Œ
    2.é‡åˆ°setTimeoutï¼Œæ¨å…¥å®ä»»åŠ¡ï¼Œå¾…åé¢æ‰§è¡Œï¼Œ
    3.é‡åˆ°Promiseï¼Œé¦–å…ˆæ‰“å° 3ï¼ŒæŠŠthenåé¢çš„æ¨å…¥å¾®ä»»åŠ¡ï¼Œ
    4.ç›´æ¥æ‰“å° 5ï¼Œ
    6.é‡åˆ°setTimeoutï¼Œæ¨å…¥å®ä»»åŠ¡ï¼Œå¾…åé¢æ‰§è¡Œï¼Œ
    7.å¾®ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ‰“å° 4ï¼Œ
    8.å®ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ‰“å° 2ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰å¾®ä»»åŠ¡ï¼Œä¸‹ä¸€æ­¥ï¼Œ
    9.æ‰§è¡Œå®ä»»åŠ¡ï¼Œæ‰“å° 6ï¼ŒæŠŠthenåé¢çš„æ¨å…¥å¾®ä»»åŠ¡ï¼Œ
    10.æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œæ‰“å° 7ï¼Œå®Œæˆã€‚
 ```


 ### 2.å°è¯•è¾“å‡ºä»¥ä¸‹ä»£ç  

 ```javascript
    async function async1() {
        console.log('async1 start');
        await async2();
        console.log('async1 end');
    }
    async function async2() {
        console.log('async2');
    }
    console.log('script start');
    setTimeout(function() {
        console.log('setTimeout');
    }, 0)
    async1();
    new Promise(function(resolve) {
        console.log('promise1');
        resolve();
    }).then(function() {
        console.log('promise2');
    });
    console.log('script end');

    /**
        await async2()ç­‰ä»·äº
        async2().then(() => {
                console.log('async1 end');
        })
    **/ 
 ```


 ```javascript
    /*
        script start
        async1 start
        async2
        promise1
        script end
        async1 end
        promise2
        setTimeout
    */
    1.é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªasyncï¼Œæ²¡è°ƒç”¨ï¼Œç›´æ¥ä¸‹ä¸€æ­¥ï¼Œ
    2.æ‰§è¡Œ script startï¼Œ
    3.é‡åˆ°setTimeoutï¼Œ æ¨å…¥å®ä»»åŠ¡ï¼Œ
    3.æ‰§è¡Œ async1å‡½æ•°,åœ¨awaitä¹‹å‰çš„ä»£ç æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¼šç«‹å³è¾“å‡º async1 start,é‡åˆ°äº†awaitæ—¶ï¼Œä¼šå°†awaitåé¢çš„è¡¨è¾¾å¼æ‰§è¡Œä¸€éï¼Œæ‰€ä»¥å°±ç´§æ¥ç€è¾“å‡ºasync2,æ‰“å°async2ï¼Œ
    4.å¾€ä¸‹èµ°ï¼Œé‡åˆ°Promiseï¼Œæ‰“å°promise1ï¼Œ thenæ¨å…¥å¾®ä»»åŠ¡ï¼Œ
    5.å¾€ä¸‹èµ°ï¼Œæ‰“å°script endï¼Œ
    6.ç»§ç»­æŒ‰é¡ºåºæ‰§è¡Œä¹‹å‰ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡ï¼Œå…ˆæ‰“å°async1 endï¼Œ å†æ‰“å° promise2ï¼Œ
    7.æ‰§è¡Œå®ä»»åŠ¡ï¼Œæ‰“å°setTimeoutã€‚
 ```