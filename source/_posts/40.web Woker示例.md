---
title: 四十、 web worker
date: 2023-11-16
tags:
 - web worker
---


### 什么是 web worker
```js
Web Worker 是 HTML5 标准的一部分，这一规范定义了一套 API，
允许我们在 js 主线程之外开辟新的 Worker 线程，
并将一段 js 脚本运行其中，它赋予了开发者利用 js 操作多线程的能力。
因为是独立的线程，Worker 线程与 js 主线程能够同时运行，互不阻塞。
所以，在我们有大量运算任务时，可以把运算任务交给 Worker 线程去处理，
当 Worker 线程计算完成，
再把结果返回给 js 主线程。
这样，js 主线程只用专注处理业务逻辑，
不用耗费过多时间去处理大量复杂计算，
从而减少了阻塞时间，也提高了运行效率，页面流畅度和用户体验自然而然也提高了。

```

### 使用
```js
const worker = new Worker(new URL('./utils/autoUpdate.ts', import.meta.url), {
    type: 'module',
});
console.error('---> worker', worker);

worker.postMessage({
    url: `${window.location.protocol}//${window.location.host}`,
});

worker.onmessage = (e) => {
    if (e.data === 1) {
        ElMessageBox.alert('页面已更新，点击刷新页面', {
            confirmButtonText: '刷新',
            showClose: false,
            callback: (action: any) => {
                window.location.reload();
            },
        });
    }
};

worker.onerror = (err) => {
    console.error('->>>err', err);
};



```

##### autoUpdate.ts
```js

export let previousTimeTag: string | null; // 时间戳，响应头中的tag和last-modified字段之一
let url: string; // 请求的url
let intervalTimer: number; // 轮询的定时器
// 获取当前最新时间戳
async function getTimeTag() {
	const res = await fetch(url, {
		method: 'HEAD',
		cache: 'no-cache',
	});
	return res.headers.get('etag') || res.headers.get('last-modified');
}

// 判断Tag是否发生变化
async function juede() {
	const currentTimeTag: string | null = await getTimeTag();
	console.log('currentTimeTag--> ' + currentTimeTag, ' ________ ' + 'previousTimeTag--> ' + previousTimeTag);

	if (currentTimeTag !== previousTimeTag) {
		intervalTimer && clearInterval(intervalTimer);
		self.postMessage(1);
	}
}

self.onmessage = function (e): void {
	const data = e.data;
	if ('url' in data) {
		try {
			url = data['url'];
			(async function () {
				// 通过立即执行函数，记录首次请求的时间戳，以便与后面轮询得出的时间戳进行对比
				previousTimeTag = await getTimeTag();
				intervalTimer && clearInterval(intervalTimer);
				// 执行轮询juede函数
				intervalTimer = setInterval(juede, 60 * 1000 * 5);
			})();
		} catch (err) {
			console.log('Worker got unknown message:111' + err);
		}
	} else {
		console.log('Worker got unknown message:' + data);
	}
};
```